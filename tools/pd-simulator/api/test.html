<!DOCTYPE html>
<html>
<head>
    <title>PD Simulator Control</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        select, input {
            width: 100%;
            height: 30px;
            word-wrap: break-word;
        }
        #left {
            float: left;
        }
        #right {
            float: right;
        }
        #log, #config {
            box-sizing: border-box;
            position: fixed;
            right: 0;
            width: 50%;
            height: 50%;
            overflow: auto;
            border-left: 1px solid #000;
            padding: 10px;
            margin: 0;
        }
        #log {
            top: 50%;
            border-top: 1px solid #000;
        }
        #config {
            top: 0;
        }
    </style>
</head>
<body>
<h1>PD Simulator Control</h1>
<div id="left">
    <select id="mode">
        <option value="kvsimulator">Simulator</option>
        <option value="api">API</option>
        <option value="tso">TSO</option>
    </select>
    <select id="options" style="display: none;">
    </select>
    <select id="http-method">
        <option value="get">GET</option>
        <option value="post">POST</option>
        <option value="delete">DELETE</option>
    </select>
    <select id="simulator_case" type="string" placeholder="simulator_case" style="display: none;">
    </select>
    <select id="api_case" type="string" placeholder="api_case" style="display: none;">
    </select>
    <input id="qps" type="number" placeholder="qps" style="display: none;">
    <input id="burst" type="number" placeholder="burst" style="display: none;">
    <input id="key" type="text" placeholder="key" style="display: none;">
    <input id="value" type="text" placeholder="value" style="display: none;">
    <button id="send-request">Send Request</button>
    <pre id="response"></pre>
</div>
<div id="right">
    <pre id="config"></pre>
    <pre id="log"></pre>
</div>

<script>
    const configURL = 'http://127.0.0.1:10081/pd/simulator/config';

       $(document).ready(function() {
        var generalOptions = [
            "/start",
            "/stop",
            "/config",
        ];
        var apiOptions = [
            "/config",
            "/http/all",
            "/http/:name",
            "/grpc/all",
            "/grpc/:name",
            "/etcd/all",
            "/etcd/:name",
        ];
        var apiGRPCOptions = [
            "GetRegion",
            "GetRegionEnableFollower",
            "GetStore",
            "GetStores",
            "ScanRegions",
            "Tso",
            "UpdateGCSafePoint",
            "UpdateServiceGCSafePoint",
        ];
        var HTTPOptions = [
            "GetRegionStatus",
            "GetMinResolvedTS",
        ]
        var ETCDOptions = [
            "Get",
            "Put",
            "Delete",
            "Txn",
        ]
        var simulatorOptions = [
            "/config",
            "/event",
        ];
        var simulatorEvent = [
            "add-node",
            "remove-node",
        ];

        $('#mode').change(function() {
            var mode = $(this).val();
            $('#options').empty();
            if (mode === 'api') {
                for (var i = 0; i < apiOptions.length; i++) {
                    $('#options').append('<option value="' + apiOptions[i] + '">' + apiOptions[i] + '</option>');
                }
            }
            if (mode === 'tso') {
                for (var i = 0; i < generalOptions.length; i++) {
                    $('#options').append('<option value="' + generalOptions[i] + '">' + generalOptions[i] + '</option>');
                }
            }
            if (mode === 'kvsimulator') {
                for (var i = 0; i < simulatorOptions.length; i++) {
                    $('#options').append('<option value="' + simulatorOptions[i] + '">' + simulatorOptions[i] + '</option>');
                }
            }
            $('#options').show();
        });

       $('#options').change(function() {
           var option = $(this).val();
           if (option.includes(':name')) {
               if (option.includes('http')) {
                   $('#api_case').empty();
                   for (var i = 0; i < HTTPOptions.length; i++) {
                       $('#api_case').append('<option value="' + HTTPOptions[i] + '">' + HTTPOptions[i] + '</option>');
                   }
               }
                if (option.includes('grpc')) {
                     $('#api_case').empty();
                     for (var i = 0; i < apiGRPCOptions.length; i++) {
                          $('#api_case').append('<option value="' + apiGRPCOptions[i] + '">' + apiGRPCOptions[i] + '</option>');
                     }
                }
                if (option.includes('etcd')) {
                     $('#api_case').empty();
                     for (var i = 0; i < ETCDOptions.length; i++) {
                          $('#api_case').append('<option value="' + ETCDOptions[i] + '">' + ETCDOptions[i] + '</option>');
                     }
                }
                $('#api_case').show();
               $('#qps, #burst').show();
           } else {
               $('#qps, #burst').hide();
           }

           if (option.includes('config')) {
                $('#key, #value').show();
              } else {
                $('#key, #value').hide();
           }

           if (option.includes('event')) {
            for (var i = 0; i < simulatorEvent.length; i++) {
                    $('#simulator_case').append('<option value="' + simulatorEvent[i] + '">' + simulatorEvent[i] + '</option>');
                }
                $('#simulator_case').show();
              } else {
                $('#simulator_case').hide();
           }
       });

       $('#send-request').click(function() {
           var mode = $('#mode').val();
           var option = $('#options').val();
           var httpMethod = $('#http-method').val();
           var key = $('#key').val();
           var value = $('#value').val();
           var data = {};
           data[key] = isNaN(value) ? value : Number(value);

              if (option.includes('config')) {
                var url = 'http://127.0.0.1:10081/pd/simulator/'+mode +'/config'
                $.ajax({
        url: url,
        type: httpMethod.toUpperCase(),
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(data) {
            $('#response').text(JSON.stringify(data, null, 2));
            $('#log').append('Triggered API: ' + url + ' ' + httpMethod.toUpperCase() + '\n');
        },
    });
    return;
           }

           if (mode === 'api' && option) {
               var url = 'http://127.0.0.1:10081/pd/simulator/api' + option;
               if (option.includes(':name')) {
                   var caseName = $('#api_case').val();
                   var qps = $('#qps').val();
                   var burst = $('#burst').val();
                   url = url.replace(':name', caseName);
                   url += '?qps=' + qps + '&burst=' + burst;
               }
               $.ajax({
                   url: url,
                   type: httpMethod.toUpperCase(),
                   success: function(data) {
                       $('#response').text(JSON.stringify(data, null, 2));
                       $('#log').append('Triggered API: ' + url + ' ' + httpMethod.toUpperCase() + '\n');
                   },
               });
           } else if (mode === 'kvsimulator' && option) {
                if (option.includes('event')) {
                    var simulatorCase = $('#simulator_case').val();
                    var url = 'http://127.0.0.1:10081/pd/simulator/kvsimulator/event/' + simulatorCase;
                    $.ajax({
                        url: url,
                        type: httpMethod.toUpperCase(),
                        success: function(data) {
                            $('#response').text(JSON.stringify(data, null, 2));
                            $('#log').append('Triggered API: ' + url + ' ' + httpMethod.toUpperCase() + '\n');
                        },
                    });
                } else {

               var url = 'http://127.0.0.1:10081/pd/simulator/' + mode + option;
               if (option.includes('case')) {
                   var caseName = $('#case_name').val();
                   url = url.replace(':name', caseName);
               }
                $.ajax({
                     url: url,
                     type: httpMethod.toUpperCase(),
                     success: function(data) {
                          $('#response').text(JSON.stringify(data, null, 2));
                          $('#log').append('Triggered API: ' + url + ' ' + httpMethod.toUpperCase() + '\n');
                     },
                });
                }
           } else {
            var url = 'http://127.0.0.1:10081/pd/simulator/' + mode + option;
            $.ajax({
                url: url,
                type: httpMethod.toUpperCase(),
                success: function(data) {
                    $('#response').text(JSON.stringify(data, null, 2));
                    $('#log').append('Triggered API: ' + url + ' ' + httpMethod.toUpperCase() + '\n');
                },
            });
           }

$.ajax({
    url: configURL,
    type: 'GET',
    dataType: 'text', // change this to 'text' so jQuery doesn't try to parse the response
    success: function(data) {
        console.log(data); // log the raw response
        try {
            var parsedData = JSON.parse(data); // manually parse the response
            $('#config').text(JSON.stringify(parsedData, null, 2));
        } catch (e) {
            console.error('Error parsing JSON:', e);
        }
    },
    error: function(jqXHR, textStatus, errorThrown) {
        console.log('Request failed: ' + textStatus + ', ' + errorThrown);
    }
});

       });
   });
</script>
</body>
</html>
